package com.urviclean.recordbook.controllers;
import com.urviclean.recordbook.models.DailySaleRecordInput;
import com.urviclean.recordbook.models.ExpenseItem;
import com.urviclean.recordbook.models.SalesExpenseRequest;
import com.urviclean.recordbook.models.DailySaleRecordResponse;
import com.urviclean.recordbook.models.SalesmanExpenseResponse;
import com.urviclean.recordbook.models.SalesExpenseResponse;
import com.urviclean.recordbook.utils.CommissionCalculator;
import com.fasterxml.jackson.annotation.JsonFormat;
import com.urviclean.recordbook.models.DailySaleCustomerType;
import com.urviclean.recordbook.models.DailySaleRecord;
import com.urviclean.recordbook.models.ExpenseCategory;
import com.urviclean.recordbook.models.Salesman;
import com.urviclean.recordbook.models.SalesmanExpense;
import com.urviclean.recordbook.repositories.DailySaleRecordRepository;
import com.urviclean.recordbook.repositories.SalesmanExpenseRepository;
import com.urviclean.recordbook.repositories.SalesmanRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.bind.annotation.*;
import java.math.BigDecimal;
import java.time.LocalDate;
import java.util.ArrayList;
import java.util.List;

@RestController
@RequestMapping("/api/sales")
@CrossOrigin(origins = "http://localhost:3000")
public class DailySaleController {

    @Autowired
    private DailySaleRecordRepository repository;

    @Autowired
    private SalesmanRepository salesmanRepository;

    @Autowired
    private SalesmanExpenseRepository salesmanExpenseRepository;

    @PostMapping
    public DailySaleRecord createRecord(@RequestBody DailySaleRecord record) {
        return repository.save(record);
    }

    @GetMapping
    public List<DailySaleRecord> getAllRecords() {
        return repository.findAll();
    }

    @PutMapping("/{id}")
    public DailySaleRecord updateRecord(@PathVariable Long id, @RequestBody DailySaleRecord newDetails) {
        return repository.findById(id)
                .map(record -> {
                    // Requires Lombok @Data in DailySaleRecord.java
                    record.setCustomerName(newDetails.getCustomerName());
                    record.setQuantity(newDetails.getQuantity());
                    return repository.save(record);
                }).orElseThrow(() -> new RuntimeException("Record not found"));
    }

    @DeleteMapping("/{id}")
    public void deleteRecord(@PathVariable Long id) {
        repository.deleteById(id);
    }

    // 1. Filter by Product Code: /api/sales/filter/product-code?code=ABC123
    @GetMapping("/filter/product-code")
    public List<DailySaleRecord> getByProductCode(@RequestParam String code) {
        return repository.findByProductCode(code);
    }

    // 2. Filter by Quantity: /api/sales/filter/quantity?value=5
    @GetMapping("/filter/quantity")
    public List<DailySaleRecord> getByQuantity(@RequestParam Integer value) {
        return repository.findByQuantity(value);
    }

    // 3. Filter by Product Code AND Quantity: /api/sales/filter/search?code=ABC123&quantity=10
    @GetMapping("/filter/search")
    public List<DailySaleRecord> getByProductCodeAndQuantity(
            @RequestParam String code,
            @RequestParam Integer quantity) {
        return repository.findByProductCodeAndQuantity(code, quantity);
    }

    // POST with request body for alias + expenses + daily sales
    @PostMapping("/sales-expense")
    @Transactional
    public ResponseEntity<SalesExpenseResponse> addSalesAndExpenses(@RequestBody SalesExpenseRequest request) {
        if (request == null || request.salesmanAlias == null || request.salesmanAlias.isBlank()) {
            return ResponseEntity.badRequest().build();
        }
        Salesman salesman = salesmanRepository.findByAliasIgnoreCase(request.salesmanAlias.trim())
                .orElseThrow(() -> new RuntimeException("Salesman not found for alias: " + request.salesmanAlias));

        LocalDate requestDate = request.date;

        List<SalesmanExpense> expenseEntities = new ArrayList<>();
        if (request.expenses != null) {
            for (ExpenseItem item : request.expenses) {
                SalesmanExpense expense = new SalesmanExpense();
                expense.setSalesman(salesman);
                expense.setExpenseDate(item.expenseDate != null ? item.expenseDate : requestDate);
                expense.setCategory(parseExpenseCategory(item.category));
                expense.setAmount(item.amount);
                expenseEntities.add(expense);
            }
        }

        List<DailySaleRecord> saleEntities = new ArrayList<>();
        if (request.dailySales != null) {
            for (DailySaleRecordInput item : request.dailySales) {
                DailySaleRecord record = new DailySaleRecord();
                record.setSlNo(item.slNo);
                record.setSaleDate(item.saleDate != null ? item.saleDate : requestDate);
                record.setSalesmanName(request.salesmanAlias.trim());
                record.setCustomerName(item.customerName);
                record.setCustomerType(item.customerType);
                record.setVillage(item.village);
                record.setMobileNumber(item.mobileNumber);
                record.setProductCode(item.productCode);
                record.setQuantity(item.quantity);
                record.setRate(item.rate);
                record.setRevenue(resolveRevenue(item.quantity, item.rate, item.revenue));
                // Calculate agent commission (per unit Ã— quantity)
                BigDecimal commission = CommissionCalculator.calculateCommission(item.productCode, item.rate, item.quantity);
                record.setAgentCommission(commission);

                // Check for duplicate before adding
                if (!isDuplicate(record)) {
                    saleEntities.add(record);
                }
            }
        }

        List<SalesmanExpense> savedExpenses = salesmanExpenseRepository.saveAll(expenseEntities);
        List<DailySaleRecord> savedSales = repository.saveAll(saleEntities);

        // Convert to response DTOs (without IDs)
        List<SalesmanExpenseResponse> expenseResponses = savedExpenses.stream()
                .map(SalesmanExpenseResponse::new)
                .toList();
        List<DailySaleRecordResponse> saleResponses = savedSales.stream()
                .map(DailySaleRecordResponse::new)
                .toList();

        return ResponseEntity.ok(new SalesExpenseResponse(expenseResponses, saleResponses));
    }

    private BigDecimal resolveRevenue(Integer quantity, BigDecimal rate, BigDecimal revenue) {
        if (revenue != null) {
            return revenue;
        }
        if (quantity == null || rate == null) {
            return null;
        }
        return rate.multiply(BigDecimal.valueOf(quantity));
    }

    private ExpenseCategory parseExpenseCategory(String value) {
        if (value == null || value.isBlank()) {
            return ExpenseCategory.Other;
        }
        String normalized = value.trim().replace(' ', '_');
        try {
            return ExpenseCategory.valueOf(normalized);
        } catch (IllegalArgumentException ex) {
            return ExpenseCategory.Other;
        }
    }

    /**
     * Check if a duplicate record already exists in the database.
     * A record is duplicate if all these fields match:
     * - saleDate, salesmanName, customerName, customerType, village,
     *   mobileNumber, productCode, quantity, rate, revenue
     */
    private boolean isDuplicate(DailySaleRecord record) {
        List<DailySaleRecord> existingRecords = repository.findAll();

        for (DailySaleRecord existing : existingRecords) {
            if (isSameRecord(existing, record)) {
                return true;
            }
        }
        return false;
    }

    /**
     * Compare two records to check if they have identical field values
     */
    private boolean isSameRecord(DailySaleRecord r1, DailySaleRecord r2) {
        return equals(r1.getSaleDate(), r2.getSaleDate())
                && equals(r1.getSalesmanName(), r2.getSalesmanName())
                && equals(r1.getCustomerName(), r2.getCustomerName())
                && equals(r1.getCustomerType(), r2.getCustomerType())
                && equals(r1.getVillage(), r2.getVillage())
                && equals(r1.getMobileNumber(), r2.getMobileNumber())
                && equals(r1.getProductCode(), r2.getProductCode())
                && equals(r1.getQuantity(), r2.getQuantity())
                && equals(r1.getRate(), r2.getRate())
                && equals(r1.getRevenue(), r2.getRevenue());
    }

    /**
     * Null-safe equality check
     */
    private boolean equals(Object o1, Object o2) {
        if (o1 == null && o2 == null) return true;
        if (o1 == null || o2 == null) return false;
        return o1.equals(o2);
    }
}
